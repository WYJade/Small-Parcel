# 实施计划: OMS 小包裹管理页面

## 概述

本实施计划将 OMS 小包裹管理页面的设计转化为可执行的开发任务。实施采用增量开发方式，优先构建核心功能，然后逐步添加高级特性。技术栈使用 React + TypeScript (前端) 和 Node.js + Express (后端)，数据库使用 PostgreSQL 支持表分区。

## 任务列表

- [x] 1. 搭建项目基础架构
  - 创建前端项目结构（React + TypeScript + Ant Design）
  - 创建后端项目结构（Node.js + Express + TypeScript）
  - 配置 ESLint、Prettier 和 TypeScript 编译选项
  - 设置开发环境和构建脚本
  - _需求: 1.1, 2.1_

- [-] 2. 实现数据库层和数据模型
  - [x] 2.1 创建订单表分区结构
    - 编写 SQL 脚本创建按 archive_flag 和 create_time 分区的订单表
    - 创建活跃订单分区（archive_flag=0）和归档订单分区（archive_flag=1）
    - 创建必要的索引（airbill_no, customer_name, status, create_time）
    - _需求: 4.1_

  - [x] 2.2 定义 TypeScript 数据模型
    - 定义 Order、OrderStatus、FilterConfig、PaginationConfig 等类型
    - 定义 API 请求和响应的接口类型
    - 定义用户权限相关的类型
    - _需求: 2.1, 3.1, 10.1_

  - [x] 2.3 编写数据模型单元测试
    - 测试类型定义的正确性
    - 测试数据验证逻辑
    - _需求: 2.1_

- [ ] 3. 实现后端 API - 订单查询服务
  - [ ] 3.1 实现订单查询 API 端点
    - 创建 GET /api/orders/small-parcel 路由
    - 实现查询参数解析（page, pageSize, includeArchived, search, filters）
    - 实现数据库查询逻辑，支持分区裁剪
    - 实现分页和排序功能
    - _需求: 2.2, 3.2, 3.3, 4.2, 4.3_

  - [ ] 3.2 编写属性测试：归档订单查询一致性
    - **属性 2: 归档订单查询一致性**
    - **验证: 需求 3.2, 3.3, 4.2, 4.3**

  - [ ] 3.3 实现搜索功能
    - 在 airbillNo、customerName、billingRef 字段中实现关键词搜索
    - 使用 LIKE 或全文搜索优化查询性能
    - _需求: 6.2_

  - [ ] 3.4 编写属性测试：搜索结果匹配性
    - **属性 6: 搜索结果匹配性**
    - **验证: 需求 6.2**

  - [ ] 3.5 实现过滤器功能
    - 支持按 status、serviceType、serviceCenter、dateRange 过滤
    - 构建动态 SQL 查询条件
    - _需求: 5.1, 5.2_

  - [ ] 3.6 编写单元测试：查询和过滤功能
    - 测试各种查询参数组合
    - 测试边界情况（空结果、大数据量）
    - _需求: 2.2, 6.2_

- [ ] 4. 实现后端 API - 权限控制
  - [ ] 4.1 实现认证中间件
    - 创建 JWT 认证中间件
    - 实现用户角色验证
    - 创建 GET /api/auth/permissions 端点
    - _需求: 10.1_

  - [ ] 4.2 实现归档订单权限控制
    - 在查询 API 中添加权限检查中间件
    - 对非 Operations_Manager 用户强制 includeArchived=false
    - 返回权限错误响应
    - _需求: 3.4, 3.5, 10.2, 10.3, 10.4_

  - [ ] 4.3 编写属性测试：权限查询限制
    - **属性 11: 权限查询限制**
    - **验证: 需求 10.2, 10.3**

  - [ ] 4.4 编写属性测试：未授权访问错误提示
    - **属性 12: 未授权访问错误提示**
    - **验证: 需求 10.4**

- [ ] 5. 检查点 - 后端 API 基础功能完成
  - 确保所有测试通过，如有问题请询问用户

- [ ] 6. 实现后端 API - 导出服务
  - [ ] 6.1 实现导出任务创建 API
    - 创建 POST /api/orders/small-parcel/export 端点
    - 估算导出数据量
    - 判断是否需要二次确认（> 50,000 行）
    - 创建导出任务记录
    - _需求: 8.2, 8.3_

  - [ ] 6.2 实现导出任务确认和执行 API
    - 创建 POST /api/orders/small-parcel/export/confirm 端点
    - 异步执行导出任务
    - 生成 CSV 或 Excel 文件
    - 返回下载链接
    - _需求: 8.4, 8.5_

  - [ ] 6.3 编写属性测试：导出数据一致性
    - **属性 9: 导出数据一致性**
    - **验证: 需求 8.2**

  - [ ] 6.4 编写单元测试：导出功能
    - 测试数据量估算逻辑
    - 测试导出文件生成
    - 测试边界情况（超过 50,000 行）
    - _需求: 8.3, 8.4_

- [ ] 7. 实现前端 - 页面布局和导航
  - [ ] 7.1 创建主页面组件
    - 创建 SmallParcel 主页面组件
    - 实现侧边栏导航和主内容区域布局
    - 添加页面标题和描述文本
    - _需求: 1.1, 1.2, 1.3_

  - [ ] 7.2 创建顶部工具栏
    - 添加搜索框组件
    - 添加高级搜索、列设置、导出按钮
    - _需求: 1.4_

  - [ ] 7.3 编写单元测试：页面布局
    - 测试页面结构的正确渲染
    - 测试标题和描述文本的显示
    - 测试工具栏按钮的存在性
    - _需求: 1.1, 1.2, 1.3, 1.4_

- [ ] 8. 实现前端 - 订单表格组件
  - [ ] 8.1 创建 OrderTable 组件
    - 使用 Ant Design Table 组件
    - 定义所有必需的列（AIRBILL NO, CUSTOMER NAME 等）
    - 实现分页功能（10/20/50/100 条/页）
    - 显示总记录数
    - _需求: 2.1, 2.3, 2.4_

  - [ ] 8.2 实现列配置功能
    - 创建 ColumnSettings 组件
    - 实现列的显示/隐藏切换
    - 使用 localStorage 保存列配置
    - _需求: 7.1, 7.2, 7.3, 7.4_

  - [ ] 8.3 编写属性测试：列可见性控制
    - **属性 7: 列可见性控制**
    - **验证: 需求 7.3**

  - [ ] 8.4 编写属性测试：列配置持久化
    - **属性 8: 列配置持久化**
    - **验证: 需求 7.4**

  - [ ] 8.5 编写单元测试：表格组件
    - 测试表格渲染
    - 测试分页交互
    - 测试列配置功能
    - _需求: 2.1, 2.4, 7.3_

- [ ] 9. 实现前端 - 过滤器和搜索功能
  - [ ] 9.1 创建 FilterBar 组件
    - 显示"Active Filters:"区域
    - 显示激活的过滤器标签
    - 实现"Clear All"按钮功能
    - _需求: 5.1, 5.2, 5.3, 5.4_

  - [ ] 9.2 实现"Include Archived Orders"复选框
    - 根据用户权限显示/隐藏复选框
    - 实现复选框状态管理
    - 触发查询参数更新
    - _需求: 3.1, 3.4, 3.5_

  - [ ] 9.3 编写属性测试：权限控制复选框可见性
    - **属性 3: 权限控制复选框可见性**
    - **验证: 需求 3.4, 3.5**

  - [ ] 9.4 编写属性测试：过滤器标签显示一致性
    - **属性 4: 过滤器标签显示一致性**
    - **验证: 需求 5.1, 5.2**

  - [ ] 9.5 编写属性测试：清除过滤器操作
    - **属性 5: 清除过滤器操作**
    - **验证: 需求 5.4**

  - [ ] 9.6 创建 SearchBar 组件
    - 实现搜索输入框
    - 实现搜索关键词提交
    - 添加搜索防抖优化
    - _需求: 6.1, 6.2_

  - [ ] 9.7 创建 AdvancedSearch 组件
    - 创建高级搜索对话框
    - 实现多字段搜索表单
    - 实现搜索条件提交
    - _需求: 6.3, 6.4_

  - [ ] 9.8 编写单元测试：过滤器和搜索
    - 测试过滤器标签显示
    - 测试清除过滤器功能
    - 测试搜索输入和提交
    - _需求: 5.4, 6.2, 6.4_

- [ ] 10. 实现前端 - 数据获取和状态管理
  - [ ] 10.1 创建订单服务（orderService）
    - 实现 getOrders API 调用
    - 实现错误处理和重试逻辑
    - 使用 Axios 拦截器统一处理响应
    - _需求: 2.2_

  - [ ] 10.2 创建认证服务（authService）
    - 实现 getPermissions API 调用
    - 实现 JWT token 管理
    - _需求: 10.1_

  - [ ] 10.3 实现 Redux 状态管理
    - 创建 orderSlice 管理订单状态
    - 实现异步 thunk 处理 API 调用
    - 管理 loading、error 状态
    - _需求: 2.2, 9.1, 9.5_

  - [ ] 10.4 创建自定义 Hooks
    - 创建 useOrders hook 封装订单数据获取
    - 创建 useFilters hook 管理过滤器状态
    - 创建 usePermissions hook 管理权限状态
    - _需求: 2.2, 5.1, 10.1_

  - [ ] 10.5 编写属性测试：默认查询活跃订单
    - **属性 1: 默认查询活跃订单**
    - **验证: 需求 2.2**

  - [ ] 10.6 编写属性测试：加载状态指示器一致性
    - **属性 10: 加载状态指示器一致性**
    - **验证: 需求 9.1, 9.5**

- [ ] 11. 检查点 - 前端核心功能完成
  - 确保所有测试通过，如有问题请询问用户

- [ ] 12. 实现前端 - 导出功能
  - [ ] 12.1 创建 ExportDialog 组件
    - 创建导出对话框 UI
    - 实现格式选择（CSV/Excel）
    - 实现二次确认对话框（> 50,000 行）
    - 显示导出进度指示器
    - _需求: 8.1, 8.3, 8.4_

  - [ ] 12.2 实现导出服务调用
    - 调用导出任务创建 API
    - 处理二次确认流程
    - 调用导出确认 API
    - 下载生成的文件
    - _需求: 8.2, 8.5_

  - [ ] 12.3 编写单元测试：导出功能
    - 测试导出对话框显示
    - 测试二次确认逻辑（边界情况）
    - 测试导出进度显示
    - _需求: 8.3, 8.4_

- [ ] 13. 实现响应式设计
  - [ ] 13.1 实现桌面端布局
    - 优化 ≥1280px 屏幕的表格布局
    - 确保所有列正确显示
    - _需求: 11.1_

  - [ ] 13.2 实现移动端适配
    - 添加媒体查询处理 <1280px 屏幕
    - 实现表格横向滚动或卡片式布局
    - 优化触摸交互
    - _需求: 11.2, 11.3, 11.4_

  - [ ] 13.3 编写属性测试：响应式布局调整
    - **属性 13: 响应式布局调整**
    - **验证: 需求 11.2**

  - [ ] 13.4 编写单元测试：响应式设计
    - 测试不同屏幕尺寸的布局
    - 测试移动端卡片式布局
    - _需求: 11.1, 11.2_

- [ ] 14. 实现错误处理和用户反馈
  - [ ] 14.1 实现前端错误处理
    - 添加 Axios 拦截器处理网络错误
    - 实现错误边界组件
    - 显示用户友好的错误提示
    - _需求: 10.4_

  - [ ] 14.2 实现加载状态和提示
    - 显示查询加载指示器
    - 显示归档订单加载提示（> 3 秒）
    - 显示导出进度指示器
    - _需求: 9.1, 9.3, 9.5_

  - [ ] 14.3 编写单元测试：错误处理
    - 测试网络错误提示
    - 测试权限错误提示
    - 测试错误边界组件
    - _需求: 10.4_

- [ ] 15. 性能优化
  - [ ] 15.1 优化数据库查询
    - 验证分区裁剪效果（使用 EXPLAIN ANALYZE）
    - 优化索引使用
    - 添加查询结果缓存（Redis）
    - _需求: 4.2, 4.3, 9.4_

  - [ ] 15.2 优化前端性能
    - 实现虚拟滚动（大数据量表格）
    - 添加搜索防抖
    - 使用 React.memo 优化组件渲染
    - 实现代码分割和懒加载
    - _需求: 9.4_

  - [ ] 15.3 编写性能测试
    - 测试活跃订单查询时间（< 2 秒）
    - 测试分页查询性能
    - 测试导出性能
    - _需求: 9.4_

- [ ] 16. 集成测试和端到端测试
  - [ ] 16.1 编写集成测试
    - 测试前后端 API 集成
    - 测试数据库查询与 API 响应
    - 测试权限验证流程
    - _需求: 所有需求_

  - [ ] 16.2 编写端到端测试（使用 Cypress 或 Playwright）
    - 测试完整的用户流程（登录 → 查询 → 过滤 → 导出）
    - 测试归档订单查看流程
    - 测试权限控制流程
    - _需求: 所有需求_

- [ ] 17. 最终检查点 - 确保所有功能完整
  - 运行所有测试（单元测试、属性测试、集成测试）
  - 验证所有需求已实现
  - 检查代码质量和测试覆盖率
  - 如有问题请询问用户

## 注意事项

- 每个任务都引用了具体的需求编号以确保可追溯性
- 检查点任务确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证具体示例和边界情况
